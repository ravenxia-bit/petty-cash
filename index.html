<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç°¡æ˜“é›¶ç”¨é‡‘ç³»çµ±</title>
<link rel="preconnect" href="https://pcash.ravenxia1205-801.workers.dev">
<link rel="dns-prefetch" href="https://pcash.ravenxia1205-801.workers.dev">
<style>
:root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
--acc:#22d3ee; --danger:#ef4444; --ok:#22c55e; --line:#1f2937; --chip:#0b2a33 }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
.wrap{max-width:1100px;margin:auto;padding:20px}
header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
h1{font-size:20px;margin:0}
.actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button,.btn{background:#0b2133;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
button:hover{border-color:#244b63}
.btn-primary{background:#082432;border-color:#0e3b52}
.btn-danger{background:#2a0f13;border-color:#511b21}
.btn-ghost{background:transparent}
.muted{color:var(--muted);font-size:13px}
.role-badge{padding:4px 8px;border-radius:999px;border:1px solid #0e3b52;background:#072133}
.inline-field{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.calendar-btn{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b2133;cursor:pointer}
.calendar-btn:hover{border-color:#244b63}
.invalid{border-color:var(--danger)!important; outline: none}

.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:14px 0 8px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
.card h3{margin:0 0 4px;font-size:13px;color:var(--muted)}
.card .val{font-size:22px;font-weight:700}
.val.in{color:var(--ok)} .val.out{color:var(--danger)} .val.bal{color:var(--acc)}
.hint{margin:0 0 12px}

.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.toolbar input,.toolbar select{background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}

/* æ‰‹æ©Ÿ/æ¡Œæ©Ÿæ—¥æœŸå€é–“æ’ç‰ˆ */
.date-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.date-group{display:grid;grid-template-columns:auto minmax(160px,1fr) auto;gap:8px;align-items:center}
.date-group label{white-space:nowrap}
.tilde{white-space:nowrap}
.tilde-mobile{display:none}

.table-wrap{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
table{width:100%;border-collapse:collapse;min-width:760px}
th,td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted);font-weight:600;background:#0c1526}
tr:hover td{background:#0a1422}
.chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid #103543}
.money.in{color:var(--ok);font-weight:700}
.money.out{color:var(--danger);font-weight:700}
.empty{padding:24px;color:var(--muted);text-align:center}
.disabled{opacity:.5;pointer-events:none}
.amt-input{width:100%; background:#0b1220;border:1px solid var(--line);color:var(--text);padding:8px;border-radius:10px}

.table-scroller{overflow:auto}
@media (max-width: 720px){
  .summary{grid-template-columns:1fr}
  .toolbar{flex-direction:column}
  .date-row{display:grid;gap:8px}
  .date-group{grid-template-columns:auto 1fr auto}
  .tilde{display:none}
  .tilde-mobile{display:inline}
  .table-wrap{border:none;background:transparent}
  table{display:none}
  .list{display:grid;gap:10px}
  .row-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;gap:8px}
  .row-top{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .row-mid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row-note{color:var(--muted);font-size:13px}
  .row-actions{display:flex;gap:8px;justify-content:flex-end}
}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,10,20,.6);padding:16px;z-index:40}
.modal.show{display:flex}
.dialog{width:100%;max-width:600px;background:var(--card);border:1px solid var(--line);border-radius:16px}
.dialog header{padding:14px 16px;border-bottom:1px solid var(--line)}
.dialog .body{padding:16px;display:grid;gap:12px}
.dialog footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end}
.form-row{display:grid;gap:8px}
.form-row.inline{grid-template-columns:1fr 1fr;gap:10px}
label{font-size:13px;color:var(--muted)}
input[type="text"], input[type="number"], input[type="date"], select{
  background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;width:100%
}
.req::after{content:"*";color:var(--danger);margin-left:4px}

.login .dialog{max-width:460px}
.login h3{margin:0 0 6px;font-size:18px}
.login .role-cta{display:flex;gap:8px;flex-wrap:wrap}
.warn{font-size:12px;color:#eab308}

.loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
.loading.show{display:flex}
</style>
</head>
<body>
<div class="wrap">
<header>
  <h1>ç°¡æ˜“é›¶ç”¨é‡‘ç³»çµ±</h1>
  <div class="actions">
    <span id="roleBadge" class="role-badge muted">æœªç™»å…¥</span>
    <button id="loginBtn" class="btn">ç™»å…¥ / åˆ‡æ›</button>
    <button id="logoutBtn" class="btn-ghost" style="display:none">ç™»å‡º</button>
    <span class="muted">|</span>
    <button id="addBtn" class="btn-primary">ï¼‹ æ–°å¢ç´€éŒ„</button>
    <button id="loadAllBtn" class="btn-ghost" title="è¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼ˆå¯èƒ½è¼ƒæ…¢ï¼‰">è¼‰å…¥å…¨éƒ¨</button>
    <button id="exportBtn" class="btn">åŒ¯å‡º JSON</button>
    <label id="importWrap" class="btn-ghost" style="border:1px dashed var(--line);padding:8px 12px;border-radius:10px;cursor:pointer">
      åŒ¯å…¥ JSON <input id="importInput" type="file" accept="application/json" style="display:none">
    </label>
  </div>
</header>

<section class="summary">
  <div class="card"><h3>ç¸½æ”¶å…¥ï¼ˆç›®å‰è¼‰å…¥ï¼‰</h3><div class="val in" id="sumIn">0</div></div>
  <div class="card"><h3>ç¸½æ”¯å‡ºï¼ˆç›®å‰è¼‰å…¥ï¼‰</h3><div class="val out" id="sumOut">0</div></div>
  <div class="card"><h3>çµé¤˜ï¼ˆç›®å‰è¼‰å…¥ï¼‰</h3><div class="val bal" id="balance">0</div></div>
</section>
<p class="muted hint" id="loadHint" style="display:none">ç›®å‰åƒ…è¼‰å…¥æœ€è¿‘è³‡æ–™ã€‚è‹¥éœ€å®Œæ•´çµ±è¨ˆï¼Œè«‹é»å³ä¸Šè§’ã€Œè¼‰å…¥å…¨éƒ¨ã€ã€‚</p>

<!-- ç¯©é¸ï¼šæ‰‹æ©Ÿå…©è¡Œï¼ˆå„è‡ªæœ‰ğŸ“…ï¼‰ï¼Œæ¡Œæ©ŸåŒæ’ -->
<section class="toolbar">
  <div class="date-row">
    <div class="date-group">
      <label class="muted" for="dateFrom">èµ·å§‹æ—¥æœŸ</label>
      <input type="date" id="dateFrom" />
      <button id="openFromCal" class="calendar-btn" type="button" title="é–‹å•Ÿèµ·å§‹æ—¥æ›†">ğŸ“…</button>
      <input type="date" id="dateFromFallback" style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none" tabindex="-1" />
    </div>
    <span class="tilde muted">~</span>
    <div class="date-group">
      <label class="muted" for="dateTo"><span class="tilde-mobile">~ </span>çµæŸæ—¥æœŸ</label>
      <input type="date" id="dateTo" />
      <button id="openToCal" class="calendar-btn" type="button" title="é–‹å•ŸçµæŸæ—¥æ›†">ğŸ“…</button>
      <input type="date" id="dateToFallback" style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none" tabindex="-1" />
    </div>
  </div>

  <select id="typeFilter">
    <option value="">å…¨éƒ¨é¡å‹</option>
    <option value="income">æ”¶å…¥</option>
    <option value="expense">æ”¯å‡º</option>
  </select>
  <select id="categoryFilter"></select>

  <input type="text" id="kw" placeholder="æœå°‹å‚™è¨»é—œéµå­—â€¦" />
  <button id="applyFilters" class="btn-ghost">ä¾æ¢ä»¶æœå°‹</button>
  <button id="clearFilters" class="btn-ghost">æ¸…é™¤ç¯©é¸</button>
</section>

<section class="table-wrap">
  <div class="table-scroller">
    <table id="tbl">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>é¡å‹</th>
          <th>åˆ†é¡</th>
          <th>å‚™è¨»</th>
          <th style="text-align:right">é‡‘é¡</th>
          <th style="width:180px">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="list" id="list"></div>
  <div class="empty" id="empty" style="display:none">ç›®å‰æ²’æœ‰ç´€éŒ„</div>
</section>
</div>

<!-- æ–°å¢/ç·¨è¼¯ Modal -->
<div class="modal" id="entryModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <header><h2 id="dlgTitle" style="font-size:16px;margin:0">æ–°å¢ç´€éŒ„</h2></header>
    <div class="body">
      <div class="form-row inline">
        <div class="form-row">
          <label class="req">æ—¥æœŸ</label>
          <div class="inline-field">
            <input id="fDate" type="date" required />
            <button id="openFDateCal" class="calendar-btn" type="button" title="é–‹å•Ÿæ—¥æ›†">ğŸ“…</button>
            <input id="fDateFallback" type="date" style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none" tabindex="-1" />
          </div>
        </div>
        <div class="form-row">
          <label class="req">é¡å‹</label>
          <select id="fType" required>
            <option value="expense">æ”¯å‡º</option>
            <option value="income">æ”¶å…¥</option>
          </select>
        </div>
      </div>
      <div class="form-row inline">
        <div class="form-row">
          <label class="req">åˆ†é¡</label>
          <select id="fCategory" required></select>
        </div>
        <div class="form-row">
          <label id="noteLabel">å‚™è¨»</label>
          <input id="fNote" type="text" placeholder="ä¾‹å¦‚ï¼šå“é …ï¼æ•¸é‡â€¦" />
          <div class="muted" id="noteHint"></div>
        </div>
      </div>
      <div class="form-row">
        <label class="req">é‡‘é¡</label>
        <input id="fAmount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="è«‹è¼¸å…¥é‡‘é¡" required />
      </div>
    </div>
    <footer>
      <button class="btn-ghost" id="cancelBtn">å–æ¶ˆ</button>
      <button class="btn-primary" id="saveBtn">å„²å­˜</button>
    </footer>
  </div>
</div>

<!-- ç™»å…¥ Modal -->
<div class="modal login" id="loginModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <header><h2 id="loginTitle" style="font-size:16px;margin:0">ç™»å…¥ç³»çµ±</h2></header>
    <div class="body">
      <div class="form-row">
        <h3>é¸æ“‡è§’è‰²</h3>
        <div class="role-cta">
          <button id="asGuest" class="btn">ä»¥è¨ªå®¢é€²å…¥ï¼ˆå¯æ–°å¢ï¼›ä¸å¯ç·¨è¼¯/åˆªé™¤ï¼‰</button>
          <button id="asAdmin" class="btn-primary">ç®¡ç†è€…ç™»å…¥</button>
        </div>
      </div>
      <div id="adminForm" class="form-row" style="display:none">
        <label class="req">ç®¡ç†è€…å¯†ç¢¼</label>
        <input id="adminPwd" type="password" placeholder="è¼¸å…¥ admin å¯†ç¢¼" />
      </div>
    </div>
    <footer>
      <button class="btn-ghost" id="loginCancel">é—œé–‰</button>
      <button class="btn-primary" id="loginOk">ç¢ºèª</button>
    </footer>
  </div>
</div>

<div class="loading" id="loading"><div class="card">è³‡æ–™è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦</div></div>

<script>
/* ====== API é€£ç·šï¼ˆCloudflare Workerï¼‰ ====== */
const API_URL = 'https://pcash.ravenxia1205-801.workers.dev';
const INITIAL_LIMIT = 300;
const LS_CACHE = 'pettyCashCache.v1';
const LS_ROLE  = 'pettyCashRole.v1';

const POST_HEADERS = { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' };
const postForm = (payload)=>
  fetch(API_URL, { method:'POST', headers:POST_HEADERS, body:new URLSearchParams({ json: JSON.stringify(payload) }) })
  .then(async r => { const j = await r.json().catch(()=>({ok:false,error:'bad json'})); return j; });

async function listEntries(params={}) {
  const qs = new URLSearchParams({ action:'list', ...params });
  const res = await fetch(API_URL + '?' + qs.toString(), { method:'GET' }).catch(err=>{ throw new Error('network'); });
  if(!res) throw new Error('network');
  const json = await res.json().catch(()=>({ok:false,error:'bad json'}));
  if(!json.ok) throw new Error(json.error||'list failed');
  return json.rows||[];
}
async function addEntry(row){ const j=await postForm({action:'add',row}); if(!j.ok) throw new Error(j.error||'add failed'); return j.id; }
async function updateEntry(id,patch){ const j=await postForm({action:'update',id,patch}); if(!j.ok) throw new Error(j.error||'update failed'); }
async function deleteEntry(id){ const j=await postForm({action:'delete',id}); if(!j.ok) throw new Error(j.error||'delete failed'); }

/* ====== ç‹€æ…‹ ====== */
let entries = [];
let editingId = null;
let role = localStorage.getItem(LS_ROLE) || '';
let loadedAll = false;

/* ====== åˆ†é¡ ====== */
const INCOME_CATS  = ['é›¶ç”¨é‡‘','å…¶ä»–'];
const EXPENSE_CATS = ['é›è›‹','è”¬æœ','å†°å¡Š','è±†æ¼¿','é¼å®‡','å»£å¼˜','å’–å•¡','ç‰›å¥¶','äº”é‡‘','éœé›»æ©Ÿä¿é¤Š','è£œPOS','å…¶ä»–'];

/* ====== Helpers ====== */
const $ = s => document.querySelector(s);
const isMobile = () => matchMedia('(max-width:720px)').matches;
const fmtMoney = n => (n||0).toLocaleString('zh-TW',{minimumFractionDigits:2,maximumFractionDigits:2});
const todayStr = () => new Date().toISOString().slice(0,10);
const showLoading = on => $('#loading').classList.toggle('show', !!on);
const saveCache = () => localStorage.setItem(LS_CACHE, JSON.stringify({ ts:Date.now(), rows:entries, limit:loadedAll?0:INITIAL_LIMIT }));

function setRole(next){
  role = next; localStorage.setItem(LS_ROLE, role);
  $('#roleBadge').textContent = role ? (role==='admin'?'ç®¡ç†è€…':'è¨ªå®¢') : 'æœªç™»å…¥';
  $('#logoutBtn').style.display = role ? '' : 'none';
  const showDataIO = (role==='admin');
  $('#exportBtn').style.display = showDataIO ? '' : 'none';
  $('#importWrap').style.display = showDataIO ? '' : 'none';
  populateFilterCategories($('#typeFilter').value, $('#categoryFilter').value);
  render();
}

/* ====== åˆ†é¡/å‚™è¨»è¦å‰‡ ====== */
function populateCategoryForForm(type, keepVal){
  const base = (type==='income') ? INCOME_CATS : EXPENSE_CATS;
  const list = (role==='admin') ? Array.from(new Set([...base,'å·®é¡èª¿æ•´'])) : base.slice();
  const sel = $('#fCategory');
  sel.innerHTML = list.map(c=>`<option>${c}</option>`).join('');
  if(keepVal && !list.includes(keepVal)) sel.innerHTML = `<option>${keepVal}</option>` + sel.innerHTML;
  sel.value = keepVal && list.includes(keepVal) ? keepVal : sel.options[0].value;
}
function populateFilterCategories(typeVal, keepVal){
  let catsIncome = INCOME_CATS.slice();
  let catsExpense= EXPENSE_CATS.slice();
  if(role==='admin'){
    if(!catsIncome.includes('å·®é¡èª¿æ•´'))  catsIncome.push('å·®é¡èª¿æ•´');
    if(!catsExpense.includes('å·®é¡èª¿æ•´')) catsExpense.push('å·®é¡èª¿æ•´');
  }
  const sel = $('#categoryFilter');
  let html = '<option value="">å…¨éƒ¨åˆ†é¡</option>';
  if(typeVal==='income') html += catsIncome.map(c=>`<option>${c}</option>`).join('');
  else if(typeVal==='expense') html += catsExpense.map(c=>`<option>${c}</option>`).join('');
  else {
    html += `<optgroup label="æ”¶å…¥">${catsIncome.map(c=>`<option>${c}</option>`).join('')}</optgroup>`;
    html += `<optgroup label="æ”¯å‡º">${catsExpense.map(c=>`<option>${c}</option>`).join('')}</optgroup>`;
  }
  sel.innerHTML = html;
  if(keepVal) sel.value = keepVal;
}
function applyNoteRequired(){
  const type = $('#fType').value;
  const cat  = $('#fCategory').value;
  const note = $('#fNote');
  const label= $('#noteLabel');
  const hint = $('#noteHint');
  const required = (cat==='å…¶ä»–');
  note.required = required;
  label.classList.toggle('req', required);
  hint.textContent = required
    ? (type==='income'?'æ”¶å…¥ï¼å…¶ä»–ï¼šå‚™è¨»å¿…å¡«':'æ”¯å‡ºï¼å…¶ä»–ï¼šå‚™è¨»å¿…å¡«')
    : (type==='income'?'æ”¶å…¥ï¼é›¶ç”¨é‡‘ï¼šå‚™è¨»å¯ç•™ç™½':'æ”¯å‡ºï¼éã€Œå…¶ä»–ã€ï¼šå‚™è¨»å¯ç•™ç™½');
}

/* ====== ç¯©é¸ï¼ˆæ—¥æœŸå€é–“ï¼‰ ====== */
function applyFilters(list){
  const from = $('#dateFrom').value || '';
  const to   = $('#dateTo').value   || '';
  const typ  = $('#typeFilter').value;
  const cat  = $('#categoryFilter').value;
  const kw   = $('#kw').value.trim();
  return list.filter(x=>{
    if(from && x.date < from) return false;
    if(to   && x.date > to)   return false;
    if(typ && x.type !== typ) return false;
    if(cat && x.category !== cat) return false;
    if(kw  && !(x.note||'').includes(kw)) return false;
    return true;
  });
}

/* ====== æ¸²æŸ“ ====== */
function calcSummary(list){
  const sumIn  = list.filter(x=>x.type==='income').reduce((s,x)=>s+x.amount,0);
  const sumOut = list.filter(x=>x.type==='expense').reduce((s,x)=>s+x.amount,0);
  $('#sumIn').textContent = fmtMoney(sumIn);
  $('#sumOut').textContent = fmtMoney(sumOut);
  $('#balance').textContent= fmtMoney(sumIn - sumOut);
}
function rowToHTML(item){
  const moneyClass = item.type==='income'?'in':'out';
  const disableActions = (role!=='admin');
  const amountCell = role==='admin'
    ? `<input class="amt-input" type="number" min="0" step="0.01" value="${item.amount}" data-amt="1" />`
    : `<span class="money ${moneyClass}">${fmtMoney(item.amount)}</span>`;
  return `
    <tr data-id="${item.id}">
      <td>${item.date}</td>
      <td><span class="chip">${item.type==='income'?'æ”¶å…¥':'æ”¯å‡º'}</span></td>
      <td>${item.category}</td>
      <td>${item.note||''}</td>
      <td style="text-align:right">${amountCell}</td>
      <td>
        <button class="btn ${disableActions?'disabled':''}" data-act="edit">ç·¨è¼¯</button>
        <button class="btn btn-danger ${disableActions?'disabled':''}" data-act="del">åˆªé™¤</button>
      </td>
    </tr>`;
}
function rowToCard(item){
  const moneyClass = item.type==='income'?'in':'out';
  const disableActions = (role!=='admin');
  const amountBlock = role==='admin'
    ? `<input class="amt-input" type="number" min="0" step="0.01" value="${item.amount}" data-amt="1" />`
    : `<div class="money ${moneyClass}">${fmtMoney(item.amount)}</div>`;
  return `
    <div class="row-card" data-id="${item.id}">
      <div class="row-top">
        <div><span class="chip">${item.type==='income'?'æ”¶å…¥':'æ”¯å‡º'}</span>ã€€${item.category}</div>
        <div>${amountBlock}</div>
      </div>
      <div class="row-mid">
        <div><strong>æ—¥æœŸ</strong>ï¼š${item.date}</div>
        <div><strong>å‚™è¨»</strong>ï¼š<span class="row-note">${item.note||'â€”'}</span></div>
      </div>
      <div class="row-actions">
        <button class="btn ${disableActions?'disabled':''}" data-act="edit">ç·¨è¼¯</button>
        <button class="btn btn-danger ${disableActions?'disabled':''}" data-act="del">åˆªé™¤</button>
      </div>
    </div>`;
}
function render(){
  const sorted = entries.slice().sort((a,b)=> b.date.localeCompare(a.date));
  const filtered = applyFilters(sorted);
  calcSummary(filtered);
  const tbody=$('#tbody'), list=$('#list'), empty=$('#empty');
  if(filtered.length===0){
    tbody.innerHTML=''; list.innerHTML=''; empty.style.display='block';
    list.style.display = isMobile()? 'grid' : 'none';
    return;
  } else { empty.style.display='none'; }
  if(isMobile()){
    list.style.display='grid'; tbody.innerHTML=''; list.innerHTML = filtered.map(rowToCard).join('');
  }else{
    list.style.display='none'; tbody.innerHTML = filtered.map(rowToHTML).join('');
  }
}

/* ====== ç™»å…¥ ====== */
const ADMIN_PASS = 'ssY@94540923';
function openLogin(){ const m=$('#loginModal'); m.classList.add('show'); m.setAttribute('aria-hidden','false'); $('#adminForm').style.display='none'; }
function closeLogin(){ const m=$('#loginModal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); $('#adminPwd').value=''; }
$('#loginBtn').addEventListener('click', openLogin);
$('#logoutBtn').addEventListener('click', ()=>{ setRole(''); openLogin(); });
$('#asGuest').addEventListener('click', ()=>{ $('#adminForm').style.display='none'; setRole('guest'); closeLogin(); });
$('#asAdmin').addEventListener('click', ()=>{ $('#adminForm').style.display='grid'; $('#adminPwd').focus(); });
$('#loginCancel').addEventListener('click', closeLogin);
$('#loginOk').addEventListener('click', ()=>{
  if($('#adminForm').style.display!=='none'){
    const ok = ($('#adminPwd').value===ADMIN_PASS);
    if(!ok){ alert('å¯†ç¢¼éŒ¯èª¤'); return; }
    setRole('admin'); closeLogin();
    if(document.getElementById('entryModal').classList.contains('show')){
      populateCategoryForForm($('#fType').value, $('#fCategory').value);
      applyNoteRequired();
    }
  }else{ setRole('guest'); closeLogin(); }
});

/* ====== æ–°å¢/ç·¨è¼¯ ====== */
function openEntry(editItem){
  $('#entryModal').classList.add('show');
  $('#entryModal').setAttribute('aria-hidden','false');
  const d=$('#fDate'), t=$('#fType'), n=$('#fNote'), a=$('#fAmount');
  if(editItem){
    $('#dlgTitle').textContent='ç·¨è¼¯ç´€éŒ„';
    editingId=editItem.id;
    t.value=editItem.type;
    populateCategoryForForm(t.value, editItem.category);
    d.value=editItem.date; fDateFallback.value=d.value; n.value=editItem.note||''; a.value=editItem.amount;
  }else{
    $('#dlgTitle').textContent='æ–°å¢ç´€éŒ„';
    editingId=null;
    t.value='expense';
    populateCategoryForForm('expense', null);
    d.value=todayStr(); fDateFallback.value=d.value;
    n.value=''; a.value='';
  }
  applyNoteRequired();
  setTimeout(()=>$('#fDate').focus(),0);
}
function closeEntry(){ $('#entryModal').classList.remove('show'); $('#entryModal').setAttribute('aria-hidden','true'); }
$('#addBtn').addEventListener('click', ()=> openEntry(null));
$('#cancelBtn').addEventListener('click', closeEntry);
$('#fType').addEventListener('change', ()=>{ populateCategoryForForm($('#fType').value, null); applyNoteRequired(); });
$('#fCategory').addEventListener('change', applyNoteRequired);

$('#saveBtn').addEventListener('click', async ()=>{
  const date=$('#fDate').value, type=$('#fType').value, category=$('#fCategory').value;
  const note=$('#fNote').value.trim(); const amount=parseFloat($('#fAmount').value);
  if(!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');
  if(!type) return alert('è«‹é¸æ“‡é¡å‹');
  if(!category) return alert('è«‹é¸æ“‡åˆ†é¡');
  if(category==='å…¶ä»–' && !note) return alert('æ­¤åˆ†é¡éœ€å¡«å¯«å‚™è¨»');
  if(!(amount>=0)) return alert('è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡');

  if(editingId){
    if(role!=='admin'){ alert('è¨ªå®¢æ¨¡å¼ä¸å¯ç·¨è¼¯'); return; }
    const idx=entries.findIndex(x=>x.id===editingId);
    const backup=idx>-1?{...entries[idx]}:null;
    if(idx>-1){ entries[idx]={...entries[idx], date, type, category, note, amount}; render(); saveCache(); }
    closeEntry();
    try{ await updateEntry(editingId,{date,type,category,note,amount}); }
    catch(e){ if(backup){ entries[idx]=backup; render(); saveCache(); } alert('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
    return;
  }

  const tempId='tmp-'+Math.random().toString(36).slice(2);
  const temp={id:tempId,date,type,category,note,amount};
  entries.unshift(temp); render(); saveCache(); closeEntry();
  try{
    const realId=await addEntry({date,type,category,note,amount});
    const i=entries.findIndex(x=>x.id===tempId);
    if(i>-1) entries[i].id=realId;
    render(); saveCache();
  }catch(err){
    const i=entries.findIndex(x=>x.id===tempId);
    if(i>-1) entries.splice(i,1);
    render(); saveCache();
    alert('æ–°å¢å¤±æ•—ï¼š'+err.message);
  }
});

/* ====== è¡Œå…§é‡‘é¡ï¼ˆadminï¼‰ ====== */
document.body.addEventListener('change', async (e)=>{
  const el=e.target;
  if(el.matches('[data-amt]')){
    if(role!=='admin') return;
    const host=el.closest('[data-id]'); if(!host) return;
    const id=host.getAttribute('data-id');
    const val=parseFloat(el.value); if(isNaN(val)) return;
    const idx=entries.findIndex(x=>x.id===id);
    const backup=idx>-1?entries[idx].amount:null;
    if(idx>-1){ entries[idx].amount=val; render(); saveCache(); }
    try{ await updateEntry(id,{amount:val}); }
    catch(err){ if(idx>-1){ entries[idx].amount=backup; render(); saveCache(); } alert('æ›´æ–°å¤±æ•—ï¼š'+err.message); }
  }
});

/* ====== åˆ—è¡¨ä¸Šçš„ç·¨è¼¯/åˆªé™¤ ====== */
document.body.addEventListener('click', async (e)=>{
  const btn=e.target.closest('button[data-act]'); if(!btn) return;
  const act=btn.dataset.act; const host=btn.closest('[data-id]'); if(!host) return;
  const id=host.getAttribute('data-id'); const item=entries.find(x=>x.id===id); if(!item) return;
  if(act==='edit'){
    if(role!=='admin'){ alert('è¨ªå®¢æ¨¡å¼ä¸å¯ç·¨è¼¯'); return; }
    openEntry(item);
  }else if(act==='del'){
    if(role!=='admin'){ alert('è¨ªå®¢æ¨¡å¼ä¸å¯åˆªé™¤'); return; }
    if(!confirm('ç¢ºèªåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return;
    const idx=entries.findIndex(x=>x.id===id);
    const backup=idx>-1?entries[idx]:null;
    if(idx>-1){ entries.splice(idx,1); render(); saveCache(); }
    try{ await deleteEntry(id); }
    catch(err){ if(backup){ entries.splice(idx,0,backup); render(); saveCache(); } alert('åˆªé™¤å¤±æ•—ï¼š'+err.message); }
  }
});

/* ====== ç¯©é¸æ§åˆ¶ ====== */
$('#applyFilters').addEventListener('click', ()=>{
  const from=$('#dateFrom').value, to=$('#dateTo').value;
  if(from && to && from>to){ alert('èµ·å§‹æ—¥æœŸä¸å¯æ™šæ–¼çµæŸæ—¥æœŸ'); return; }
  render();
});
$('#typeFilter').addEventListener('input', ()=>{
  const prev=$('#categoryFilter').value;
  populateFilterCategories($('#typeFilter').value, prev);
});
['categoryFilter','kw'].forEach(id=> $('#'+id).addEventListener('input', ()=>{}));
$('#clearFilters').addEventListener('click', ()=>{
  $('#dateFrom').value=''; $('#dateTo').value='';
  $('#typeFilter').value=''; populateFilterCategories('', '');
  $('#kw').value=''; render();
});

/* ====== æ—¥æœŸä¸‹æ‹‰ï¼ˆtoolbar çš„é›™æ—¥æ›†ï¼‰ ====== */
const fromEl=$('#dateFrom'), toEl=$('#dateTo');
const fromFb=$('#dateFromFallback'), toFb=$('#dateToFallback');
$('#openFromCal').addEventListener('click', ()=>{
  if(typeof fromEl.showPicker==='function'){ fromEl.showPicker(); return; }
  try{ fromEl.focus(); fromEl.click(); }catch(_){}
  try{ if(typeof fromFb.showPicker==='function') fromFb.showPicker(); else { fromFb.focus(); fromFb.click(); } }catch(_){}
});
$('#openToCal').addEventListener('click', ()=>{
  if(typeof toEl.showPicker==='function'){ toEl.showPicker(); return; }
  try{ toEl.focus(); toEl.click(); }catch(_){}
  try{ if(typeof toFb.showPicker==='function') toFb.showPicker(); else { toFb.focus(); toFb.click(); } }catch(_){}
});
fromFb.addEventListener('change', ()=>{ if(fromFb.value) fromEl.value=fromFb.value; });
toFb.addEventListener('change',   ()=>{ if(toFb.value)   toEl.value=toFb.value; });

/* ====== åŒ¯å‡º / åŒ¯å…¥ / è¼‰å…¥å…¨éƒ¨ ====== */
$('#exportBtn').addEventListener('click', async ()=>{
  if(role!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯åŒ¯å‡º'); return; }
  try{
    const all=await listEntries();
    const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='petty-cash.json'; a.click();
    URL.revokeObjectURL(url);
  }catch(err){ alert('åŒ¯å‡ºå¤±æ•—ï¼š'+err.message); }
});
$('#importInput').addEventListener('change', async (e)=>{
  if(role!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯åŒ¯å…¥'); e.target.value=''; return; }
  const file=e.target.files[0]; if(!file) return;
  try{
    showLoading(true);
    const text=await file.text();
    const data=JSON.parse(text);
    if(!Array.isArray(data)) throw new Error('æ ¼å¼ä¸æ­£ç¢ºï¼Œéœ€ç‚ºé™£åˆ—');
    for(const r0 of data){
      const r={date:r0.date,type:r0.type,category:r0.category,note:r0.note||'',amount:Number(r0.amount)||0};
      const id=await addEntry(r);
      entries.unshift({id,...r});
    }
    render(); saveCache(); alert('åŒ¯å…¥å®Œæˆ');
  }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message); }
  finally{ e.target.value=''; showLoading(false); }
});
$('#loadAllBtn').addEventListener('click', async ()=>{
  if(loadedAll) return;
  try{
    showLoading(true);
    const all=await listEntries();
    entries=all; loadedAll=true;
    $('#loadHint').style.display='none';
    render(); saveCache();
  }catch(err){ alert('è¼‰å…¥å…¨éƒ¨å¤±æ•—ï¼š'+err.message); }
  finally{ showLoading(false); }
});

/* ====== å•Ÿå‹• ====== */
function boot(){
  // è‹¥ä½ æ²’æœ‰ sw.jsï¼Œå¯è¨»è§£æ‰ä¸‹ä¸€è¡Œ
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

  populateFilterCategories('', '');
  setRole(role||'');
  if(!role) openLogin();

  // 1) å…ˆç•«å¿«å–
  try{
    const cached=JSON.parse(localStorage.getItem(LS_CACHE)||'null');
    if(cached && Array.isArray(cached.rows) && cached.rows.length){
      entries=cached.rows;
      loadedAll = (cached.limit ? false : true);
      $('#loadHint').style.display = cached.limit ? 'block' : 'none';
      render();
    }else{
      entries=[]; render();
    }
  }catch(_){ entries=[]; render(); }

  // 2) èƒŒæ™¯æŠ“æœ€æ–°
  (async ()=>{
    try{
      const fresh=await listEntries({limit:INITIAL_LIMIT});
      entries=fresh; loadedAll=false;
      $('#loadHint').style.display='block';
      render(); saveCache();
    }catch(err){
      console.warn('listEntries failed:', err);
      // æç¤ºç”¨æˆ¶
      if(!entries.length){
        $('#empty').style.display='block';
        $('#empty').textContent='è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦';
      }
    }
  })();

  // RWD é‡ç¹ª
  const mq=window.matchMedia('(max-width:720px)');
  (mq.addEventListener?mq.addEventListener('change',render):mq.addListener(render));
  let _rszTimer; window.addEventListener('resize',()=>{ clearTimeout(_rszTimer); _rszTimer=setTimeout(render,120); });
  window.addEventListener('orientationchange', render);
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
