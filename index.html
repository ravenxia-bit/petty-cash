<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>簡易零用金系統（Google Sheet 版）</title>
<style>
  :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --acc:#22d3ee; --danger:#ef4444; --ok:#22c55e; --line:#1f2937; --chip:#0b2a33 }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
  h1{font-size:20px;margin:0}
  .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button,.btn{background:#0b2133;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#244b63}
  .btn-primary{background:#082432;border-color:#0e3b52}
  .btn-danger{background:#2a0f13;border-color:#511b21}
  .btn-ghost{background:transparent}
  .muted{color:var(--muted);font-size:13px}
  .role-badge{padding:4px 8px;border-radius:999px;border:1px solid #0e3b52;background:#072133}
  .inline-field{display:flex;gap:6px;align-items:center}
  .calendar-btn{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b2133;cursor:pointer}
  .calendar-btn:hover{border-color:#244b63}
  .invalid{border-color:var(--danger)!important; outline: none}

  .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:14px 0 20px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:0 0 4px;font-size:13px;color:var(--muted)}
  .card .val{font-size:22px;font-weight:700}
  .val.in{color:var(--ok)} .val.out{color:var(--danger)} .val.bal{color:var(--acc)}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .toolbar input,.toolbar select{background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px}

  .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  table{width:100%;border-collapse:collapse;min-width:760px}
  th,td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{color:var(--muted);font-weight:600;background:#0c1526}
  tr:hover td{background:#0a1422}
  .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid #103543}
  .money.in{color:var(--ok);font-weight:700}
  .money.out{color:var(--danger);font-weight:700}
  .empty{padding:24px;color:var(--muted);text-align:center}
  .disabled{opacity:.5;pointer-events:none}
  .amt-input{width:100%; background:#0b1220;border:1px solid var(--line);color:var(--text);padding:8px;border-radius:10px}

  .table-scroller{overflow:auto}
  @media (max-width: 720px){
    .summary{grid-template-columns:1fr}
    .toolbar{flex-direction:column}
    .table-wrap{border:none;background:transparent}
    table{display:none}
    .list{display:grid;gap:10px}
    .row-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;gap:8px}
    .row-top{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .row-mid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row-note{color:var(--muted);font-size:13px}
    .row-actions{display:flex;gap:8px;justify-content:flex-end}
  }

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,10,20,.6);padding:16px;z-index:40}
  .modal.show{display:flex}
  .dialog{width:100%;max-width:600px;background:var(--card);border:1px solid var(--line);border-radius:16px}
  .dialog header{padding:14px 16px;border-bottom:1px solid var(--line)}
  .dialog .body{padding:16px;display:grid;gap:12px}
  .dialog footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end}
  .form-row{display:grid;gap:8px}
  .form-row.inline{grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="number"], input[type="date"], select{
    background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;width:100%
  }
  .req::after{content:"*";color:var(--danger);margin-left:4px}

  .login .dialog{max-width:460px}
  .login h3{margin:0 0 6px;font-size:18px}
  .login .role-cta{display:flex;gap:8px;flex-wrap:wrap}
  .warn{font-size:12px;color:#eab308}

  /* 簡單 loading */
  .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .loading.show{display:flex}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>簡易零用金系統</h1>
      <div class="actions">
        <span id="roleBadge" class="role-badge muted">未登入</span>
        <button id="loginBtn" class="btn">登入 / 切換</button>
        <button id="logoutBtn" class="btn-ghost" style="display:none">登出</button>
        <span class="muted">|</span>
        <button id="addBtn" class="btn-primary">＋ 新增紀錄</button>
        <button id="exportBtn" class="btn">匯出 JSON</button>
        <label id="importWrap" class="btn-ghost" style="border:1px dashed var(--line);padding:8px 12px;border-radius:10px;cursor:pointer">
          匯入 JSON <input id="importInput" type="file" accept="application/json" style="display:none">
        </label>
      </div>
    </header>

    <section class="summary">
      <div class="card"><h3>總收入</h3><div class="val in" id="sumIn">0</div></div>
      <div class="card"><h3>總支出</h3><div class="val out" id="sumOut">0</div></div>
      <div class="card"><h3>結餘</h3><div class="val bal" id="balance">0</div></div>
    </section>

    <!-- 篩選：單一日期（YYYYMMDD） + 類型 + 分類 + 關鍵字 -->
    <section class="toolbar">
      <div class="inline-field">
        <input type="text" id="dateExact" placeholder="YYYYMMDD"
               inputmode="numeric" pattern="\d{8}" maxlength="8"
               aria-describedby="dateHint" title="輸入 8 碼日期或點右側圖示開啟日曆" />
        <button id="openCalendar" class="calendar-btn" title="開啟日曆">📅</button>
        <input type="date" id="dateExactPicker"
               style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none" tabindex="-1" />
      </div>
      <div class="muted" id="dateHint">單日篩選（格式：YYYYMMDD）</div>

      <select id="typeFilter">
        <option value="">全部類型</option>
        <option value="income">收入</option>
        <option value="expense">支出</option>
      </select>
      <!-- 由 JS 依「類型」動態填入分類 -->
      <select id="categoryFilter"></select>

      <input type="text" id="kw" placeholder="搜尋備註關鍵字…" />
      <button id="clearFilters" class="btn-ghost">清除篩選</button>
    </section>

    <section class="table-wrap">
      <div class="table-scroller">
        <table id="tbl">
          <thead>
            <tr>
              <th>日期</th>
              <th>類型</th>
              <th>分類</th>
              <th>備註</th>
              <th style="text-align:right">金額</th>
              <th style="width:180px">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="list" id="list"></div>
      <div class="empty" id="empty" style="display:none">目前沒有紀錄</div>
    </section>
  </div>

  <!-- 新增/編輯 Modal（日期可手動與下拉日曆） -->
  <div class="modal" id="entryModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <header><h2 id="dlgTitle" style="font-size:16px;margin:0">新增紀錄</h2></header>
      <div class="body">
        <div class="form-row inline">
          <div class="form-row">
            <label class="req">日期</label>
            <div class="inline-field">
              <input id="fDate" type="date" required />
              <button id="openFDateCal" class="calendar-btn" type="button" title="開啟日曆">📅</button>
              <input id="fDateFallback" type="date"
                     style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none" tabindex="-1" />
            </div>
          </div>
          <div class="form-row">
            <label class="req">類型</label>
            <select id="fType" required>
              <option value="expense">支出</option>
              <option value="income">收入</option>
            </select>
          </div>
        </div>
        <div class="form-row inline">
          <div class="form-row">
            <label class="req">分類</label>
            <select id="fCategory" required></select>
          </div>
          <div class="form-row">
            <label id="noteLabel">備註</label>
            <input id="fNote" type="text" placeholder="例如：品項／數量…" />
            <div class="muted" id="noteHint"></div>
          </div>
        </div>
        <div class="form-row">
          <label class="req">金額</label>
          <input id="fAmount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="請輸入金額" required />
        </div>
      </div>
      <footer>
        <button class="btn-ghost" id="cancelBtn">取消</button>
        <button class="btn-primary" id="saveBtn">儲存</button>
      </footer>
    </div>
  </div>

  <!-- 登入 Modal（前端角色切換；非 Google 登入） -->
  <div class="modal login" id="loginModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <header><h2 id="loginTitle" style="font-size:16px;margin:0">登入系統</h2></header>
      <div class="body">
        <div class="form-row">
          <h3>選擇角色</h3>
          <div class="role-cta">
            <button id="asGuest" class="btn">以訪客進入（可新增；不可編輯/刪除）</button>
            <button id="asAdmin" class="btn-primary">管理者登入</button>
          </div>
        </div>
        <div id="adminForm" class="form-row" style="display:none">
          <label class="req">管理者密碼</label>
          <input id="adminPwd" type="password" placeholder="輸入 admin 密碼" />
          <div class="warn">提示：示範用途，未做後端驗證。若要真正權限控管，建議採用 OAuth / 自家 API。</div>
        </div>
      </div>
      <footer>
        <button class="btn-ghost" id="loginCancel">關閉</button>
        <button class="btn-primary" id="loginOk">確認</button>
      </footer>
    </div>
  </div>

  <!-- 簡易 loading -->
  <div class="loading" id="loading"><div class="card">資料處理中，請稍候…</div></div>

<script>
  /* =======================
     後端 API （Google Apps Script）
     將 API_URL 換成你部署的 Web App URL（/exec）
     將 API_SECRET 換成你在 GAS 中設定的 SECRET
     ======================= */
  const API_URL = 'https://script.google.com/macros/s/AKfycbwKrXfh6ms7EG3c-GNf71DRMzNhcCAhRrhsazWk0RWenVlxG_IGzNyxJOLztALSXvVG/exec'; // ← 改成你的
  const API_SECRET = 'jb7pRkuXUxPSL9B';     // ← 改成你的

  async function listEntries(){
    const res = await fetch(API_URL + '?action=list', { method:'GET' });
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'list failed');
    return json.rows || [];
  }
  async function addEntry(row){
    const res = await fetch(API_URL, {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ secret: API_SECRET, action:'add', row })
    });
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'add failed');
    return json.id;
  }
  async function updateEntry(id, patch){
    const res = await fetch(API_URL, {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ secret: API_SECRET, action:'update', id, patch })
    });
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'update failed');
  }
  async function deleteEntry(id){
    const res = await fetch(API_URL, {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ secret: API_SECRET, action:'delete', id })
    });
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'delete failed');
  }

  // ====== State & 常數（不再使用 localStorage 存資料） ======
  const LS_ROLE = 'pettyCashRole.v1'; // 只保留角色在前端
  let entries = [];                    // 由 API 載入
  let editingId = null;
  let role = localStorage.getItem(LS_ROLE) || '';

  const INCOME_CATS  = ['零用金','其他'];
  const EXPENSE_CATS = ['雞蛋','蔬果','冰塊','廣弘','咖啡','牛奶','五金','補POS','其他'];

  // ====== Helpers ======
  const $ = s => document.querySelector(s);
  const isMobile = () => matchMedia('(max-width:720px)').matches;
  const fmtMoney = n => (n||0).toLocaleString('zh-TW', {minimumFractionDigits:2, maximumFractionDigits:2});
  const todayStr = () => new Date().toISOString().slice(0,10);
  const showLoading = (on)=> $('#loading').classList.toggle('show', !!on);

  function setRole(next){
    role = next; localStorage.setItem(LS_ROLE, role);
    $('#roleBadge').textContent = role ? (role==='admin' ? '管理者' : '訪客') : '未登入';
    $('#logoutBtn').style.display = role ? '' : 'none';
    // admin 才能看到匯出/匯入按鈕
    const showDataIO = (role === 'admin');
    $('#exportBtn').style.display = showDataIO ? '' : 'none';
    $('#importWrap').style.display = showDataIO ? '' : 'none';
    render();
  }

  // YYYYMMDD <-> YYYY-MM-DD
  function ymdToDashed(yyyymmdd){
    if(!/^\d{8}$/.test(yyyymmdd)) return '';
    const y = yyyymmdd.slice(0,4), m = yyyymmdd.slice(4,6), d = yyyymmdd.slice(6,8);
    const mm = Number(m), dd = Number(d);
    if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return '';
    return `${y}-${m}-${d}`;
  }
  const dashedToYmd = d => (/^\d{4}-\d{2}-\d{2}$/.test(d) ? d.replaceAll('-','') : '');

  // ====== 分類 & 備註規則 ======
  function populateCategoryForForm(type, keepVal){
    const sel = $('#fCategory');
    const list = (type==='income') ? INCOME_CATS : EXPENSE_CATS;
    sel.innerHTML = list.map(c=>`<option>${c}</option>`).join('');
    if(keepVal && !list.includes(keepVal)){ sel.innerHTML = `<option>${keepVal}</option>` + sel.innerHTML; }
    sel.value = keepVal && (list.includes(keepVal)) ? keepVal : list[0];
  }
  function applyNoteRequired(){
    const type = $('#fType').value;
    const cat = $('#fCategory').value;
    const note = $('#fNote');
    const label = $('#noteLabel');
    const hint = $('#noteHint');
    const required = (cat === '其他');
    note.required = required;
    label.classList.toggle('req', required);
    hint.textContent = required
      ? (type==='income' ? '收入／其他：備註必填' : '支出／其他：備註必填')
      : (type==='income' ? '收入／零用金：備註可留白' : '支出／非「其他」：備註可留白');
  }

  // ====== 篩選 ======
  function populateFilterCategories(typeVal, keepVal){
    const sel = $('#categoryFilter');
    let html = '<option value="">全部分類</option>';
    if (typeVal === 'income'){
      html += INCOME_CATS.map(c=>`<option>${c}</option>`).join('');
    } else if (typeVal === 'expense'){
      html += EXPENSE_CATS.map(c=>`<option>${c}</option>`).join('');
    } else {
      html += `<optgroup label="收入">${INCOME_CATS.map(c=>`<option>${c}</option>`).join('')}</optgroup>`;
      html += `<optgroup label="支出">${EXPENSE_CATS.map(c=>`<option>${c}</option>`).join('')}</optgroup>`;
    }
    sel.innerHTML = html;
    if (keepVal) sel.value = keepVal;
  }
  function applyFilters(list){
    const exactText = $('#dateExact').value.trim();
    const exact = ymdToDashed(exactText);
    const typ = $('#typeFilter').value;
    const cat = $('#categoryFilter').value;
    const kw = $('#kw').value.trim();
    return list.filter(x=>{
      if(exact && x.date !== exact) return false;
      if(typ && x.type !== typ) return false;
      if(cat && x.category !== cat) return false;
      if(kw && !(x.note||'').includes(kw)) return false;
      return true;
    });
  }

  // ====== 渲染 ======
  function calcSummary(list){
    const sumIn = list.filter(x=>x.type==='income').reduce((s,x)=>s+x.amount,0);
    const sumOut = list.filter(x=>x.type==='expense').reduce((s,x)=>s+x.amount,0);
    $('#sumIn').textContent = fmtMoney(sumIn);
    $('#sumOut').textContent = fmtMoney(sumOut);
    $('#balance').textContent = fmtMoney(sumIn - sumOut);
  }
  function rowToHTML(item){
    const moneyClass = item.type==='income'?'in':'out';
    const disableActions = (role !== 'admin');
    const amountCell = role==='admin'
      ? `<input class="amt-input" type="number" min="0" step="0.01" value="${item.amount}" data-amt="1" />`
      : `<span class="money ${moneyClass}">${fmtMoney(item.amount)}</span>`;
    return `
      <tr data-id="${item.id}">
        <td>${item.date}</td>
        <td><span class="chip">${item.type==='income'?'收入':'支出'}</span></td>
        <td>${item.category}</td>
        <td>${item.note||''}</td>
        <td style="text-align:right">${amountCell}</td>
        <td>
          <button class="btn ${disableActions?'disabled':''}" data-act="edit">編輯</button>
          <button class="btn btn-danger ${disableActions?'disabled':''}" data-act="del">刪除</button>
        </td>
      </tr>`;
  }
  function rowToCard(item){
    const moneyClass = item.type==='income'?'in':'out';
    const disableActions = (role !== 'admin');
    const amountBlock = role==='admin'
      ? `<input class="amt-input" type="number" min="0" step="0.01" value="${item.amount}" data-amt="1" />`
      : `<div class="money ${moneyClass}">${fmtMoney(item.amount)}</div>`;
    return `
      <div class="row-card" data-id="${item.id}">
        <div class="row-top">
          <div><span class="chip">${item.type==='income'?'收入':'支出'}</span>　${item.category}</div>
          <div>${amountBlock}</div>
        </div>
        <div class="row-mid">
          <div><strong>日期</strong>：${item.date}</div>
          <div><strong>備註</strong>：<span class="row-note">${item.note||'—'}</span></div>
        </div>
        <div class="row-actions">
          <button class="btn ${disableActions?'disabled':''}" data-act="edit">編輯</button>
          <button class="btn btn-danger ${disableActions?'disabled':''}" data-act="del">刪除</button>
        </div>
      </div>`;
  }
  function render(){
    const filtered = applyFilters(entries.slice().sort((a,b)=>b.date.localeCompare(a.date)));
    calcSummary(filtered);
    const tbody = $('#tbody'), list = $('#list'), empty = $('#empty');

    if(filtered.length===0){
      tbody.innerHTML=''; list.innerHTML=''; empty.style.display='block';
      list.style.display = isMobile()? 'grid' : 'none';
      return;
    } else { empty.style.display='none'; }

    if(isMobile()){
      list.style.display='grid'; tbody.innerHTML=''; list.innerHTML = filtered.map(rowToCard).join('');
    }else{
      list.style.display='none'; tbody.innerHTML = filtered.map(rowToHTML).join('');
    }
  }

  // ====== 事件 ======
  // Login（前端角色切換）
  const ADMIN_PASS = 'ssY@94540923'; // 前端示範密碼（未做後端驗證）
  function openLogin(){ const m = $('#loginModal'); m.classList.add('show'); m.setAttribute('aria-hidden','false'); $('#adminForm').style.display='none'; }
  function closeLogin(){ const m = $('#loginModal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); $('#adminPwd').value=''; }

  $('#loginBtn').addEventListener('click', openLogin);
  $('#logoutBtn').addEventListener('click', ()=>{ setRole(''); openLogin(); });
  $('#asGuest').addEventListener('click', ()=>{ $('#adminForm').style.display='none'; setRole('guest'); closeLogin(); });
  $('#asAdmin').addEventListener('click', ()=>{ $('#adminForm').style.display='grid'; $('#adminPwd').focus(); });
  $('#loginCancel').addEventListener('click', closeLogin);
  $('#loginOk').addEventListener('click', ()=>{
    if($('#adminForm').style.display!=='none'){
      const ok = ($('#adminPwd').value === ADMIN_PASS);
      if(!ok){ alert('密碼錯誤'); return; }
      setRole('admin'); closeLogin();
    }else{
      setRole('guest'); closeLogin();
    }
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if($('#loginModal').classList.contains('show')) closeLogin(); if($('#entryModal').classList.contains('show')) closeEntry(); }});

  // 新增/編輯 Modal
  function openEntry(editItem){
    $('#entryModal').classList.add('show');
    $('#entryModal').setAttribute('aria-hidden','false');

    const d = $('#fDate'), t = $('#fType'), n = $('#fNote'), a = $('#fAmount');
    if(editItem){
      $('#dlgTitle').textContent = '編輯紀錄';
      editingId = editItem.id;
      t.value = editItem.type;
      populateCategoryForForm(t.value, editItem.category);
      d.value = editItem.date; n.value = editItem.note||''; a.value = editItem.amount;
    }else{
      $('#dlgTitle').textContent = '新增紀錄';
      editingId = null;
      t.value = 'expense';                               // 預設支出
      populateCategoryForForm('expense', null);
      d.value = todayStr();                              // 預設今天
      n.value = ''; a.value = '';
    }
    applyNoteRequired();
    setTimeout(()=>$('#fDate').focus(), 0);
  }
  function closeEntry(){ $('#entryModal').classList.remove('show'); $('#entryModal').setAttribute('aria-hidden','true'); }

  $('#addBtn').addEventListener('click', ()=> openEntry(null));
  $('#cancelBtn').addEventListener('click', closeEntry);
  $('#fType').addEventListener('change', ()=>{
    populateCategoryForForm($('#fType').value, null);
    applyNoteRequired();
  });
  $('#fCategory').addEventListener('change', applyNoteRequired);

  // 儲存（新增/編輯）
  $('#saveBtn').addEventListener('click', async ()=>{
    const date = $('#fDate').value;
    const type = $('#fType').value;
    const category = $('#fCategory').value;
    const note = $('#fNote').value.trim();
    const amount = parseFloat($('#fAmount').value);
    if(!date) return alert('請選擇日期');
    if(!type) return alert('請選擇類型');
    if(!category) return alert('請選擇分類');
    if(category === '其他' && !note) return alert('此分類需填寫備註');
    if(!(amount>=0)) return alert('請輸入正確金額');

    try{
      showLoading(true);
      if(editingId){
        if(role !== 'admin'){ alert('訪客模式不可編輯'); return; }
        await updateEntry(editingId, { date, type, category, note, amount });
      }else{
        await addEntry({ date, type, category, note, amount });
      }
      entries = await listEntries();
      render(); closeEntry();
    }catch(err){
      alert('操作失敗：' + err.message);
    }finally{
      showLoading(false);
    }
  });

  // 行內金額（admin）— 用 change 事件降低 API 次數
  document.body.addEventListener('change', async (e)=>{
    const el = e.target;
    if(el.matches('[data-amt]')){
      if(role!=='admin'){ return; }
      const host = el.closest('[data-id]'); if(!host) return;
      const id = host.getAttribute('data-id');
      const val = parseFloat(el.value);
      if(isNaN(val)) return;
      try{
        showLoading(true);
        await updateEntry(id, { amount: val });
        entries = await listEntries();
        render();
      }catch(err){ alert('更新失敗：' + err.message); }
      finally{ showLoading(false); }
    }
  });

  // 列表上的編輯/刪除
  document.body.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const host = btn.closest('[data-id]');
    if(!host) return;
    const id = host.getAttribute('data-id');
    const item = entries.find(x=>x.id===id);
    if(!item) return;

    if(act==='edit'){
      if(role!=='admin'){ alert('訪客模式不可編輯'); return; }
      openEntry(item);
    }else if(act==='del'){
      if(role!=='admin'){ alert('訪客模式不可刪除'); return; }
      if(!confirm('確認刪除這筆紀錄？')) return;
      try{
        showLoading(true);
        await deleteEntry(id);
        entries = await listEntries();
        render();
      }catch(err){ alert('刪除失敗：' + err.message); }
      finally{ showLoading(false); }
    }
  });

  // 篩選：日期（文字 + 日曆）
  const dateTxt = $('#dateExact');
  const datePicker = $('#dateExactPicker');
  $('#openCalendar').addEventListener('click', ()=>{
    if(datePicker.showPicker){ datePicker.showPicker(); }
    else { datePicker.focus(); datePicker.click(); }
  });
  datePicker.addEventListener('change', ()=>{
    const ymd = dashedToYmd(datePicker.value);
    dateTxt.value = ymd; dateTxt.classList.remove('invalid'); render();
  });
  dateTxt.addEventListener('input', ()=>{
    const digits = dateTxt.value.replace(/\D/g,'').slice(0,8);
    if(dateTxt.value !== digits) dateTxt.value = digits;
    if(digits.length === 0){ dateTxt.classList.remove('invalid'); datePicker.value=''; }
    else if(digits.length === 8 && ymdToDashed(digits)){ dateTxt.classList.remove('invalid'); datePicker.value = ymdToDashed(digits); }
    else { dateTxt.classList.add('invalid'); datePicker.value=''; }
    render();
  });

  // 篩選：類型變動 → 連動分類
  $('#typeFilter').addEventListener('input', ()=>{
    const prev = $('#categoryFilter').value;
    populateFilterCategories($('#typeFilter').value, prev);
    render();
  });
  ['categoryFilter','kw'].forEach(id=> $('#'+id).addEventListener('input', render));
  $('#clearFilters').addEventListener('click', ()=>{
    dateTxt.value=''; dateTxt.classList.remove('invalid'); datePicker.value='';
    $('#typeFilter').value='';
    populateFilterCategories('', '');
    $('#kw').value='';
    render();
  });

  // 匯出（admin：把目前 entries 另存 JSON）
  $('#exportBtn').addEventListener('click', async ()=>{
    if (role !== 'admin') { alert('只有管理者可匯出'); return; }
    try{
      showLoading(true);
      const fresh = await listEntries();
      const blob = new Blob([JSON.stringify(fresh,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'petty-cash.json'; a.click();
      URL.revokeObjectURL(url);
    }catch(err){ alert('匯出失敗：' + err.message); }
    finally{ showLoading(false); }
  });

  // 匯入（admin：逐筆呼叫 addEntry）
  $('#importInput').addEventListener('change', async (e)=>{
    if (role !== 'admin') { alert('只有管理者可匯入'); e.target.value=''; return; }
    const file = e.target.files[0]; if(!file) return;
    try{
      showLoading(true);
      const text = await file.text();
      const data = JSON.parse(text);
      if(!Array.isArray(data)) throw new Error('格式不正確，需為陣列');
      // 逐筆新增（避免 API 節流問題）
      for (const x of data){
        const row = {
          date: x.date, type: x.type, category: x.category,
          note: x.note || '', amount: Number(x.amount)||0
        };
        await addEntry(row);
      }
      entries = await listEntries();
      render(); alert('匯入完成');
    }catch(err){ alert('匯入失敗：'+err.message); }
    finally{ e.target.value=''; showLoading(false); }
  });

  // 新增視窗：日期按鈕強制開啟原生日曆（含 fallback）
  const fDate = $('#fDate');
  const fDateFallback = $('#fDateFallback');
  const fDateBtn = $('#openFDateCal');
  fDateBtn.addEventListener('click', () => {
    if (typeof fDate.showPicker === 'function') {
      fDate.focus();
      try { fDate.showPicker(); } catch { /* fallback */ }
    } else {
      fDateFallback.value = fDate.value || todayStr();
      if (typeof fDateFallback.showPicker === 'function') fDateFallback.showPicker();
      else { fDateFallback.focus(); fDateFallback.click(); }
    }
  });
  fDateFallback.addEventListener('change', () => {
    if (fDateFallback.value) fDate.value = fDateFallback.value;
  });

  // 啟動
  function boot(){
    populateFilterCategories('', '');     // 建立分類篩選下拉
    setRole(role || '');                  // 立即套用角色外觀（訪客/未登入隱藏匯出/匯入）
    if(!role) openLogin();                // 沒有已登入角色才開登入窗
    // 初次載入資料
    (async ()=>{
      try{
        showLoading(true);
        entries = await listEntries();
        render();
      }catch(err){
        alert('載入資料失敗：' + err.message);
      }finally{
        showLoading(false);
      }
    })();
    // RWD 切換重繪
    const mq = window.matchMedia('(max-width:720px)');
    (mq.addEventListener ? mq.addEventListener('change', render) : mq.addListener(render));
    let _rszTimer; window.addEventListener('resize', ()=>{ clearTimeout(_rszTimer); _rszTimer = setTimeout(render, 120); });
    window.addEventListener('orientationchange', render);
  }
  boot();
</script>
</body>
</html>

